<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RoutinePro</title>
    
    <!-- 1. Styles & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- 2. React & Babel (To run the app without a computer) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Mobile Optimizations */
        body { -webkit-tap-highlight-color: transparent; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth Fade In */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 select-none">
    <div id="root"></div>

    <!-- 3. The App Logic -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, orderBy, limit, serverTimestamp, increment, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- Firebase Config (Use the global variable from the environment) ---
        // Note: When you host this on GitHub, you will replace 'JSON.parse...' with your real config object.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Placeholder: Replace this with your own keys from Firebase Console if hosting externally
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_APP.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const { useState, useEffect, useMemo } = React;

        // --- DATA & CONSTANTS ---
        const THEMES = {
            indigo: { id: 'indigo', label: "Classic", color: "text-indigo-600", bg: "bg-indigo-50", btn: "bg-indigo-600", border: "border-indigo-200" },
            emerald: { id: 'emerald', label: "Forest", color: "text-emerald-600", bg: "bg-emerald-50", btn: "bg-emerald-600", border: "border-emerald-200" },
            rose: { id: 'rose', label: "Sunset", color: "text-rose-600", bg: "bg-rose-50", btn: "bg-rose-600", border: "border-rose-200" },
        };

        const DEFAULT_ROUTINE = [
            { time: "06:00", label: "Wake Up" },
            { time: "07:00", label: "Coaching" },
            { time: "11:00", label: "Self Study 1" },
            { time: "14:30", label: "Nap / Rest" },
            { time: "16:00", label: "Self Study 2" },
            { time: "18:30", label: "Evening Study" },
            { time: "23:00", label: "Sleep" }
        ];

        const SUBJECTS = ["Physics", "Chemistry", "Math", "Biology", "English"];

        // --- COMPONENTS ---

        const Icon = ({ name, className }) => <i className={`fa-solid fa-${name} ${className}`}></i>;

        const StarRating = ({ rating, setRating, readOnly }) => (
            <div className="flex gap-1">
                {[1, 2, 3, 4, 5].map((star) => (
                    <button key={star} 
                        disabled={readOnly}
                        onClick={() => !readOnly && setRating(star)}
                        className={`text-lg transition-transform ${!readOnly ? 'active:scale-90' : ''} ${star <= rating ? 'text-yellow-400' : 'text-gray-300'}`}
                    >
                        <i className="fa-solid fa-star"></i>
                    </button>
                ))}
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('routine');
            const [schedule, setSchedule] = useState(DEFAULT_ROUTINE);
            const [studyData, setStudyData] = useState({});
            const [dailyRatings, setDailyRatings] = useState({});
            const [diary, setDiary] = useState("");
            const [installPrompt, setInstallPrompt] = useState(null);
            const [showEndModal, setShowEndModal] = useState(false);

            // --- 1. PWA & Auth Setup ---
            useEffect(() => {
                // PWA Prompt Listener
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                });

                // Inject Manifest dynamically so it works as a PWA
                const manifest = {
                    name: "RoutinePro",
                    short_name: "Routine",
                    start_url: ".",
                    display: "standalone",
                    background_color: "#ffffff",
                    theme_color: "#4f46e5",
                    icons: [{ src: "https://cdn-icons-png.flaticon.com/512/2921/2921222.png", sizes: "192x192", type: "image/png" }]
                };
                const link = document.createElement('link');
                link.rel = 'manifest';
                link.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
                document.head.appendChild(link);

                // Auth
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            // --- 2. Data Sync ---
            useEffect(() => {
                if (!user) return;
                const today = new Date().toISOString().split('T')[0];
                
                // Real-time listener for today's data
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'dailyLogs', today), (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setStudyData(data.studyData || {});
                        setDailyRatings(data.ratings || {});
                        setDiary(data.diary || "");
                    }
                });
                return () => unsub();
            }, [user]);

            // --- 3. Actions ---
            const saveToDb = async (newData) => {
                if (!user) return;
                const today = new Date().toISOString().split('T')[0];
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'dailyLogs', today), {
                    date: today,
                    ...newData,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
            };

            const handleInstall = () => {
                if (installPrompt) installPrompt.prompt();
            };

            const getTotalHours = () => Object.values(studyData).reduce((a, b) => a + (parseFloat(b) || 0), 0);

            // --- 4. Render Tabs ---
            const renderRoutine = () => (
                <div className="space-y-3 pb-24 animate-fade">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-slate-800">Today's Schedule</h2>
                        <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-bold">
                            {new Date().toLocaleDateString('en-US', {weekday:'short'})}
                        </span>
                    </div>
                    {schedule.map((item, i) => (
                        <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                            <div className="font-mono font-bold text-slate-400 text-sm w-12">{item.time}</div>
                            <div className="flex-1 font-semibold text-slate-700">{item.label}</div>
                            {dailyRatings[item.time] ? (
                                <div className="text-yellow-400 text-sm"><Icon name="star"/> {dailyRatings[item.time]}</div>
                            ) : (
                                <button onClick={() => {
                                    const newRatings = {...dailyRatings, [item.time]: 5};
                                    setDailyRatings(newRatings);
                                    saveToDb({ ratings: newRatings });
                                }} className="text-slate-200 hover:text-indigo-500"><Icon name="circle-check" className="text-xl"/></button>
                            )}
                        </div>
                    ))}
                </div>
            );

            const renderStudy = () => (
                <div className="space-y-5 pb-24 animate-fade">
                    <div className="bg-indigo-600 rounded-3xl p-6 text-white shadow-lg shadow-indigo-200">
                        <div className="flex justify-between">
                            <div>
                                <div className="text-indigo-200 text-sm font-medium">Total Study</div>
                                <div className="text-4xl font-bold mt-1">{getTotalHours()} <span className="text-lg opacity-60">hrs</span></div>
                            </div>
                            <div className="h-12 w-12 bg-white/20 rounded-full flex items-center justify-center">
                                <Icon name="book-open" className="text-xl"/>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                        {SUBJECTS.map(sub => (
                            <div key={sub} className="bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center">
                                <span className="font-bold text-slate-700"><Icon name="book" className="text-indigo-400 mr-2"/>{sub}</span>
                                <input 
                                    type="number" 
                                    placeholder="0"
                                    className="w-16 bg-slate-50 border border-slate-200 rounded-lg p-2 text-center font-bold text-slate-700 focus:outline-indigo-500"
                                    value={studyData[sub] || ''}
                                    onChange={(e) => {
                                        const newVal = {...studyData, [sub]: e.target.value};
                                        setStudyData(newVal);
                                        saveToDb({ studyData: newVal });
                                    }}
                                />
                            </div>
                        ))}
                    </div>
                </div>
            );

            // --- 5. Main Layout ---
            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50 relative">
                    {/* Header */}
                    <div className="bg-white/80 backdrop-blur sticky top-0 z-20 px-5 py-4 flex justify-between items-center border-b border-slate-100">
                        <div className="font-bold text-xl text-indigo-700 flex items-center gap-2">
                            <Icon name="layer-group"/> RoutinePro
                        </div>
                        {installPrompt && (
                            <button onClick={handleInstall} className="bg-black text-white px-3 py-1.5 rounded-full text-xs font-bold animate-pulse">
                                <Icon name="download"/> Install
                            </button>
                        )}
                    </div>

                    {/* Content */}
                    <div className="p-5">
                        {activeTab === 'routine' && renderRoutine()}
                        {activeTab === 'study' && renderStudy()}
                        {activeTab === 'diary' && (
                            <div className="animate-fade h-[70vh] flex flex-col">
                                <textarea 
                                    className="flex-1 w-full bg-white rounded-2xl p-5 border border-slate-200 resize-none focus:outline-indigo-500 text-lg leading-relaxed"
                                    placeholder="Dear Diary..."
                                    value={diary}
                                    onChange={(e) => {
                                        setDiary(e.target.value);
                                        // Simple debounce could go here, saving directly for demo
                                        saveToDb({ diary: e.target.value });
                                    }}
                                ></textarea>
                            </div>
                        )}
                    </div>

                    {/* Bottom Nav */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 pb-safe z-30">
                        <div className="flex justify-around p-3 max-w-md mx-auto">
                            {[
                                {id: 'routine', icon: 'list', label: 'Routine'},
                                {id: 'study', icon: 'graduation-cap', label: 'Study'},
                                {id: 'diary', icon: 'pen-nib', label: 'Diary'}
                            ].map(tab => (
                                <button key={tab.id} 
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex flex-col items-center gap-1 w-16 transition-colors ${activeTab === tab.id ? 'text-indigo-600' : 'text-slate-400'}`}
                                >
                                    <Icon name={tab.icon} className="text-xl mb-1"/>
                                    <span className="text-[10px] font-bold uppercase">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

