<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RoutinePro</title>
    <meta name="description" content="Track your daily study routine and earn XP">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map: This tells the browser where to find React, Firebase, and Icons without npm -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
      }
    }
    </script>

    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 select-none">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Calendar, Clock, BookOpen, Star, Edit3, Layout, List, CheckCircle2, 
            X, Award, BarChart3, TrendingUp, RefreshCw, Loader2, PieChart, 
            Zap, Trophy, History as HistoryIcon, ShoppingBag, Coins, Check, Download, Flame 
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        import { getAuth, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, query, 
            orderBy, limit, serverTimestamp, increment, getDoc 
        } from 'firebase/firestore';

        // --- FIREBASE CONFIGURATION (Your Keys) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCWPbw_Rap695KLdYXfjOeFfidPXycsoDI",
            authDomain: "studytracker-8f335.firebaseapp.com",
            projectId: "studytracker-8f335",
            storageBucket: "studytracker-8f335.firebasestorage.app",
            messagingSenderId: "774486792552",
            appId: "1:774486792552:web:cc70a4754db8e4f25c5edd",
            measurementId: "G-DZJW6JHDQQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- APP CONSTANTS ---
        const TARGET_STUDY_HOURS = 8; 
        const THEMES = {
            indigo: { id: 'indigo', label: "Classic Indigo", price: 0, color: "indigo", bg: "bg-[#F8FAFC]" },
            emerald: { id: 'emerald', label: "Forest Focus", price: 400, color: "emerald", bg: "bg-emerald-50" },
            rose: { id: 'rose', label: "Sunset Vibes", price: 750, color: "rose", bg: "bg-rose-50" },
            sky: { id: 'sky', label: "Deep Ocean", price: 1000, color: "sky", bg: "bg-sky-50" },
            violet: { id: 'violet', label: "Royal Suite", price: 1500, color: "violet", bg: "bg-violet-50" },
        };

        const DEFAULT_ROUTINE = [
            { time: "06:00", label: "Wake Up" },
            { time: "06:30", label: "Fresh & Morning Hygiene" },
            { time: "07:00", label: "Coaching / Tuition" },
            { time: "10:00", label: "Breakfast & Rest" },
            { time: "11:00", label: "Self Study Session 1" },
            { time: "13:30", label: "Bath & Lunch" },
            { time: "14:30", label: "Nap / Rest" },
            { time: "16:00", label: "Self Study Session 2" },
            { time: "18:00", label: "Snacks & Refreshment" },
            { time: "18:30", label: "Evening Study / Coaching" },
            { time: "21:30", label: "Dinner" },
            { time: "22:30", label: "Review Day & Diary" },
            { time: "23:00", label: "Sleep" }
        ];

        const WEEKLY_SCHEDULE = {
            "Monday": DEFAULT_ROUTINE,
            "Tuesday": DEFAULT_ROUTINE,
            "Wednesday": DEFAULT_ROUTINE,
            "Thursday": DEFAULT_ROUTINE,
            "Friday": DEFAULT_ROUTINE,
            "Saturday": DEFAULT_ROUTINE,
            "Sunday": [
                { time: "07:00", label: "Wake Up" },
                { time: "08:00", label: "Weekly Revision" },
                { time: "10:00", label: "Breakfast" },
                { time: "11:00", label: "Mock Test" },
                { time: "14:00", label: "Lunch" },
                { time: "18:00", label: "Planning" },
                { time: "22:00", label: "Sleep" }
            ]
        };

        const SUBJECTS = ["Physics", "Chemistry", "Math", "Biology", "Bengali", "English"];
        const COLORS = ['#6366f1', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6', '#3b82f6'];

        // --- HELPERS ---
        const getTodayDateString = () => new Date().toISOString().split('T')[0];
        const getDayName = (date) => date.toLocaleDateString('en-US', { weekday: 'long' });
        const getGradeLetter = (p) => p >= 90 ? 'A+' : p >= 80 ? 'A' : p >= 70 ? 'B' : p >= 60 ? 'C' : p >= 50 ? 'D' : 'F';
        const getGradeColor = (g) => (g === 'A+' || g === 'A') ? 'bg-emerald-500 text-white' : g === 'B' ? 'bg-blue-500 text-white' : g === 'C' ? 'bg-yellow-500 text-white' : 'bg-red-500 text-white';
        const getHeatmapColor = (g) => !g ? 'bg-gray-200' : (g === 'A+' || g === 'A') ? 'bg-emerald-500' : g === 'B' ? 'bg-blue-400' : g === 'C' ? 'bg-yellow-400' : 'bg-red-400';

        // --- COMPONENTS ---
        const StarRating = ({ rating, setRating, max = 5, readOnly = false }) => (
            <div className="flex gap-1">
                {[...Array(max)].map((_, i) => (
                    <button key={i} type="button" disabled={readOnly} onClick={(e) => { e.preventDefault(); if (!readOnly) setRating(i + 1); }}
                        className={`transition-all p-1 active:scale-95 ${i < rating ? 'text-yellow-400' : 'text-gray-200'} ${!readOnly && 'hover:scale-110 cursor-pointer'}`}>
                        <Star fill={i < rating ? "currentColor" : "none"} size={readOnly ? 16 : 28} />
                    </button>
                ))}
            </div>
        );

        const TimelineItem = ({ item, isActive, isPast, themeColor }) => (
            <div className={`relative flex gap-4 p-4 rounded-xl border transition-all duration-500 ${isActive ? `bg-${themeColor}-50 border-${themeColor}-500 shadow-lg transform scale-[1.02] z-10` : isPast ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-gray-100'}`}>
                <div className={`absolute left-4 top-1/2 -translate-y-1/2 -translate-x-1/2 w-3 h-3 rounded-full border-2 z-20 ${isActive ? `bg-${themeColor}-500 border-${themeColor}-200 animate-pulse` : isPast ? 'bg-gray-400 border-white' : `bg-white border-${themeColor}-200`}`}></div>
                <div className={`font-mono font-bold text-lg w-14 ${isActive ? `text-${themeColor}-600` : 'text-gray-400'}`}>{item.time}</div>
                <div className="flex-1">
                    <div className={`font-semibold ${isActive ? `text-${themeColor}-900 text-lg` : 'text-gray-700'}`}>{item.label}</div>
                    {isActive && <div className={`text-xs text-${themeColor}-500 font-bold uppercase tracking-wider mt-1`}>Current Activity</div>}
                </div>
            </div>
        );

        const GradeBadge = ({ label, grade, percent }) => (
            <div className="flex flex-col items-center p-3 bg-gray-50 rounded-xl border border-gray-100 flex-1">
                <span className="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1">{label}</span>
                <div className={`text-xl font-bold px-3 py-1 rounded-lg shadow-sm ${getGradeColor(grade)}`}>{grade}</div>
                <span className="text-xs text-gray-400 mt-1 font-mono">{Math.round(percent)}%</span>
            </div>
        );

        const StudyTrendChart = ({ historyLogs, currentStudyTotal, themeColor }) => {
            const chartData = [];
            const today = new Date();
            for (let i = 6; i > 0; i--) {
                const d = new Date(); d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const log = historyLogs.find(l => l.date === dateStr);
                const total = log ? Object.values(log.studyData || {}).reduce((a, b) => a + (b.self || 0) + (b.own || 0), 0) : 0;
                chartData.push({ day: d.toLocaleDateString('en-US', { weekday: 'short' }), val: total, isToday: false });
            }
            chartData.push({ day: 'Today', val: currentStudyTotal, isToday: true });
            const maxVal = Math.max(...chartData.map(d => d.val), 6); 

            return (
                <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                    <h3 className={`text-sm font-bold text-gray-700 mb-4 flex items-center gap-2`}><TrendingUp size={16} className={`text-${themeColor}-600`}/> Study Trend (Last 7 Days)</h3>
                    <div className="flex items-end justify-between h-32 gap-2">
                        {chartData.map((d, i) => (
                            <div key={i} className="flex flex-col items-center flex-1 h-full justify-end group">
                                <div className="relative w-full flex justify-center items-end h-full">
                                    <div style={{ height: `${(d.val / maxVal) * 100}%` }} className={`w-full max-w-[20px] rounded-t-md transition-all duration-500 relative ${d.isToday ? `bg-${themeColor}-600` : `bg-${themeColor}-200 group-hover:bg-${themeColor}-300`}`}>
                                        {d.val > 0 && <span className="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] bg-gray-800 text-white px-1.5 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap">{d.val}h</span>}
                                    </div>
                                </div>
                                <span className={`text-[10px] mt-2 font-medium ${d.isToday ? `text-${themeColor}-700` : 'text-gray-400'}`}>{d.day}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SubjectPieChart = ({ history }) => {
            const totals = {}; let grandTotal = 0;
            history.forEach(log => { Object.entries(log.studyData || {}).forEach(([sub, data]) => { const val = (data.self || 0) + (data.own || 0); totals[sub] = (totals[sub] || 0) + val; grandTotal += val; }); });
            if (grandTotal === 0) return <div className="text-center text-gray-400 py-8 text-sm italic">Log some study hours to see insights!</div>;
            let currentDeg = 0;
            const gradients = Object.entries(totals).map(([sub, val], idx) => {
                const percent = (val / grandTotal) * 100; const deg = (val / grandTotal) * 360; const color = COLORS[idx % COLORS.length];
                const segment = `${color} ${currentDeg}deg ${currentDeg + deg}deg`; currentDeg += deg;
                return { sub, percent, color, segment };
            });
            const gradientString = `conic-gradient(${gradients.map(g => g.segment).join(', ')})`;
            return (
                <div className="flex flex-col items-center">
                    <div className="w-40 h-40 rounded-full shadow-inner mb-6 relative" style={{ background: gradientString }}>
                        <div className="absolute inset-4 bg-white rounded-full flex items-center justify-center flex-col shadow-sm">
                            <span className="text-2xl font-bold text-gray-800">{Math.round(grandTotal)}h</span>
                            <span className="text-[10px] text-gray-400 uppercase">Total</span>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-x-6 gap-y-2 w-full">
                        {gradients.sort((a,b) => b.percent - a.percent).map(g => (
                            <div key={g.sub} className="flex items-center justify-between text-xs">
                                <div className="flex items-center gap-2"><span className="w-2.5 h-2.5 rounded-full" style={{ background: g.color }}></span><span className="text-gray-600">{g.sub}</span></div>
                                <span className="font-bold text-gray-800">{Math.round(g.percent)}%</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ConsistencyHeatmap = ({ history }) => {
            const days = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i); const dateStr = d.toISOString().split('T')[0];
                const log = history.find(l => l.date === dateStr); days.push({ date: dateStr, grade: log?.grades?.overall?.grade, dayNum: d.getDate() });
            }
            return (
                <div className="flex flex-wrap gap-1.5 justify-center">
                    {days.map((d, i) => (
                        <div key={i} className={`w-7 h-7 rounded-md flex items-center justify-center text-[9px] font-medium text-white/90 shadow-sm transition-transform hover:scale-110 ${getHeatmapColor(d.grade)}`} title={d.date}>{d.grade ? d.grade[0] : d.dayNum}</div>
                    ))}
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [activeTab, setActiveTab] = useState('routine'); 
            const [showEndDayModal, setShowEndDayModal] = useState(false);
            const [showShopModal, setShowShopModal] = useState(false);
            const [selectedLog, setSelectedLog] = useState(null);
            const [installPrompt, setInstallPrompt] = useState(null);
            
            const [schedule, setSchedule] = useState([]);
            const [studyData, setStudyData] = useState({});
            const [diaryEntry, setDiaryEntry] = useState("");
            const [dailyRatings, setDailyRatings] = useState({});
            const [historyLogs, setHistoryLogs] = useState([]);
            const [userStats, setUserStats] = useState({ walletBalance: 0, unlockedThemes: ['indigo'], currentTheme: 'indigo' });
            const [customDiaryTime, setCustomDiaryTime] = useState("");
            const [todayGrades, setTodayGrades] = useState(null); 
            const [isSubmitting, setIsSubmitting] = useState(false);

            const themeColor = THEMES[userStats.currentTheme]?.color || 'indigo';

            const gamificationStats = useMemo(() => {
                let totalStudyHours = 0;
                historyLogs.forEach(log => { const hours = Object.values(log.studyData || {}).reduce((a, b) => a + (b.self || 0) + (b.own || 0), 0); totalStudyHours += hours; });
                const xp = Math.round(totalStudyHours * 10);
                const level = Math.floor(xp / 100) + 1;
                const nextLevelXp = level * 100;
                const progress = ((xp % 100) / 100) * 100;
                return { totalStudyHours, xp, level, nextLevelXp, progress };
            }, [historyLogs]);

            useEffect(() => { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setInstallPrompt(e); }); }, []);
            const handleInstallClick = () => { if (!installPrompt) return; installPrompt.prompt(); installPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') setInstallPrompt(null); }); };

            useEffect(() => {
                signInAnonymously(auth).catch(e => console.error(e));
                const timer = setInterval(() => setCurrentTime(new Date()), 60000);
                const unsub = onAuthStateChanged(auth, setUser);
                return () => { clearInterval(timer); unsub(); };
            }, []);

            useEffect(() => { const day = getDayName(currentTime); setSchedule(WEEKLY_SCHEDULE[day] || DEFAULT_ROUTINE); }, [currentTime]);

            useEffect(() => {
                if (!user) return;
                const todayStr = getTodayDateString();
                const todayRef = doc(db, 'users', user.uid, 'dailyLogs', todayStr);
                const unsubToday = onSnapshot(todayRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if (Object.keys(studyData).length === 0) setStudyData(data.studyData || {});
                        if (diaryEntry === "") setDiaryEntry(data.diary || "");
                        setDailyRatings(data.ratings || {});
                        if (data.grades) setTodayGrades(data.grades);
                    }
                });
                const historyQ = query(collection(db, 'users', user.uid, 'dailyLogs'), orderBy('date', 'desc'), limit(30));
                const unsubHistory = onSnapshot(historyQ, (snap) => { setHistoryLogs(snap.docs.map(d => ({ id: d.id, ...d.data() }))); });
                const statsRef = doc(db, 'users', user.uid, 'userStats', 'profile');
                const unsubStats = onSnapshot(statsRef, (snap) => { if (snap.exists()) setUserStats(snap.data()); else setDoc(statsRef, { walletBalance: 0, unlockedThemes: ['indigo'], currentTheme: 'indigo' }); });
                return () => { unsubToday(); unsubHistory(); unsubStats(); };
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const timeout = setTimeout(() => {
                    const todayStr = getTodayDateString();
                    setDoc(doc(db, 'users', user.uid, 'dailyLogs', todayStr), { date: todayStr, studyData, diary: diaryEntry, ratings: dailyRatings, lastUpdated: serverTimestamp() }, { merge: true }).catch(console.error);
                }, 2000);
                return () => clearTimeout(timeout);
            }, [studyData, diaryEntry, dailyRatings, user]);

            const handleStudyInput = (subject, type, val) => { setStudyData(prev => ({ ...prev, [subject]: { ...prev[subject], [type]: parseFloat(val) || 0 } })); };
            const handleInsertTime = () => {
                let timeStr;
                if (customDiaryTime) { const [h, m] = customDiaryTime.split(':'); const d = new Date(); d.setHours(h); d.setMinutes(m); timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } else { timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
                setDiaryEntry(prev => (prev ? prev + '\n' + `[${timeStr}] ` : `[${timeStr}] `));
            };

            const handleEndDay = async () => {
                if (!user) return;
                setIsSubmitting(true);
                try {
                    const todayStr = getTodayDateString();
                    const dailyLogRef = doc(db, 'users', user.uid, 'dailyLogs', todayStr);
                    const docSnap = await getDoc(dailyLogRef);
                    const prevData = docSnap.exists() ? docSnap.data() : {};
                    const coinsAlreadyAwarded = prevData.awardedCoins || 0;

                    let earnedStars = 0; schedule.forEach(item => earnedStars += (dailyRatings[item.time] || 0));
                    const routinePercent = schedule.length * 5 > 0 ? (earnedStars / (schedule.length * 5)) * 100 : 0;
                    const totalStudyHours = Object.values(studyData).reduce((a, b) => a + (b.self || 0) + (b.own || 0), 0);
                    
                    let studyGrade = 'B'; let studyPercent = 0;
                    const validHistory = historyLogs.filter(l => l.date !== getTodayDateString());
                    if (validHistory.length === 0) {
                        studyPercent = Math.min(100, (totalStudyHours / TARGET_STUDY_HOURS) * 100); studyGrade = getGradeLetter(studyPercent);
                    } else {
                        const recentLogs = validHistory.slice(0, 7);
                        const sumHistory = recentLogs.reduce((acc, log) => acc + Object.values(log.studyData || {}).reduce((a, b) => a + (b.self || 0) + (b.own || 0), 0), 0);
                        const avg = recentLogs.length > 0 ? sumHistory / recentLogs.length : 0;
                        if (avg === 0) { if (totalStudyHours > 0) { studyGrade = 'A+'; studyPercent = 100; } else { studyGrade = 'F'; studyPercent = 0; } }
                        else { const r = totalStudyHours / avg; if(r>=1.2){studyGrade='A+';studyPercent=100;} else if(r>=1){studyGrade='A';studyPercent=90;} else if(r>=0.8){studyGrade='B';studyPercent=80;} else if(r>=0.6){studyGrade='C';studyPercent=60;} else {studyGrade='D';studyPercent=40;} }
                    }
                    if (totalStudyHours > 0 && studyPercent === 0) { studyPercent = 20; studyGrade = 'D'; }
                    const overallPercent = (routinePercent + studyPercent) / 2;
                    const gradesPayload = { routine: { percent: routinePercent, grade: getGradeLetter(routinePercent) }, study: { percent: studyPercent, grade: studyGrade }, overall: { percent: overallPercent, grade: getGradeLetter(overallPercent) } };
                    const currentTotalCoins = Math.floor(totalStudyHours * 10);
                    const coinsToAward = Math.max(0, currentTotalCoins - coinsAlreadyAwarded);

                    await setDoc(dailyLogRef, { grades: gradesPayload, status: 'completed', ratings: dailyRatings, studyData, awardedCoins: currentTotalCoins, lastUpdated: serverTimestamp() }, { merge: true });
                    if (coinsToAward > 0) await setDoc(doc(db, 'users', user.uid, 'userStats', 'profile'), { walletBalance: increment(coinsToAward) }, { merge: true });

                    setTodayGrades(gradesPayload);
                    setTimeout(() => { setIsSubmitting(false); setShowEndDayModal(false); }, 800);
                } catch (e) { console.error(e); setIsSubmitting(false); }
            };

            const handleBuyTheme = async (theme) => { if (!user || userStats.walletBalance < theme.price) return; await setDoc(doc(db, 'users', user.uid, 'userStats', 'profile'), { walletBalance: userStats.walletBalance - theme.price, unlockedThemes: [...(userStats.unlockedThemes || []), theme.id] }, { merge: true }); };
            const handleEquipTheme = async (themeId) => { if (!user) return; await setDoc(doc(db, 'users', user.uid, 'userStats', 'profile'), { currentTheme: themeId }, { merge: true }); };
            const getTotalStudy = () => Object.values(studyData).reduce((a, b) => a + (b.self || 0) + (b.own || 0), 0);

            // --- VIEWS ---
            if (!user) return <div className="h-screen flex items-center justify-center bg-slate-50 text-indigo-600"><Loader2 className="animate-spin" size={48}/><span className="ml-3 font-bold">Loading Pro Tracker...</span></div>;

            return (
                <div className={`min-h-screen ${THEMES[userStats.currentTheme]?.bg || 'bg-[#F8FAFC]'} pb-24`}>
                    <header className="bg-white border-b border-gray-100 px-4 py-3 sticky top-0 z-20 flex justify-between items-center shadow-sm">
                        <div className={`font-bold text-xl text-${themeColor}-700 flex items-center gap-2`}><Layout size={24} /> RoutinePro</div>
                        <div className="flex items-center gap-2">
                            {installPrompt && <button onClick={handleInstallClick} className="bg-black text-white px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1 hover:bg-gray-800 transition-colors animate-pulse"><Download size={14}/> Install</button>}
                            <button onClick={() => setShowShopModal(true)} className={`flex items-center gap-1.5 bg-${themeColor}-50 text-${themeColor}-700 px-3 py-1.5 rounded-full text-xs font-bold`}> <ShoppingBag size={14}/> <span>{userStats.walletBalance || 0}</span></button>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto px-4 py-6">
                        {activeTab === 'routine' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                    <div><h2 className="text-xl font-bold text-gray-800">Hello, Student</h2><p className="text-gray-500 text-xs mt-1">{currentTime.toDateString()}</p></div>
                                    {todayGrades ? <div className={`px-4 py-2 rounded-xl text-center shadow-sm ${getGradeColor(todayGrades.overall.grade)}`}><div className="text-[10px] font-bold uppercase opacity-90">Today's Grade</div><div className="text-2xl font-extrabold">{todayGrades.overall.grade}</div></div> : <div className={`text-2xl font-light text-${themeColor}-600`}>{currentTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>}
                                </div>
                                <div className="space-y-4 relative">
                                    <div className="absolute left-4 top-4 bottom-4 w-0.5 bg-gray-200"></div>
                                    {schedule.map((item, idx) => {
                                        const start = item.time.split(':').map(Number); const currentMins = currentTime.getHours() * 60 + currentTime.getMinutes(); const itemMins = start[0] * 60 + start[1]; const next = schedule[idx+1] ? schedule[idx+1].time.split(':').map(Number) : [24,0]; const nextMins = next[0]*60 + next[1]; const isActive = currentMins >= itemMins && currentMins < nextMins; const isPast = currentMins >= nextMins;
                                        return <TimelineItem key={idx} item={item} isActive={isActive} isPast={isPast} themeColor={themeColor} />;
                                    })}
                                </div>
                                <button onClick={() => setShowEndDayModal(true)} className={`fixed bottom-24 right-4 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2 font-bold z-30 hover:scale-105 transition-transform ${todayGrades ? `bg-${themeColor}-600` : 'bg-gray-900'}`}>{todayGrades ? <RefreshCw size={20} /> : <Award size={20} />} {todayGrades ? "Update Grade" : "Finish Day"}</button>
                            </div>
                        )}

                        {activeTab === 'study' && (
                            <div className="space-y-6">
                                <StudyTrendChart historyLogs={historyLogs} currentStudyTotal={getTotalStudy()} themeColor={themeColor} />
                                <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-baseline justify-between"><span className="text-gray-500 font-bold text-sm uppercase">Total Today</span><span className={`text-3xl font-extrabold text-${themeColor}-600`}>{getTotalStudy()} <span className="text-sm font-medium text-gray-400">hrs</span></span></div>
                                <div className="grid gap-3">
                                    {SUBJECTS.map(sub => (
                                        <div key={sub} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                            <div className="flex justify-between items-center mb-3"><span className="font-bold text-gray-800">{sub}</span><span className={`text-${themeColor}-600 font-medium text-sm`}>{((studyData[sub]?.self || 0) + (studyData[sub]?.own || 0))}h</span></div>
                                            <div className="flex gap-4">
                                                <div className="flex-1"><label className="text-[10px] text-gray-400 uppercase font-bold mb-1 block">Self Study</label><input type="number" step="0.5" min="0" placeholder="0" className={`w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-${themeColor}-100`} value={studyData[sub]?.self || ''} onChange={(e) => handleStudyInput(sub, 'self', e.target.value)}/></div>
                                                <div className="flex-1"><label className="text-[10px] text-gray-400 uppercase font-bold mb-1 block">Coaching/Own</label><input type="number" step="0.5" min="0" placeholder="0" className={`w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-${themeColor}-100`} value={studyData[sub]?.own || ''} onChange={(e) => handleStudyInput(sub, 'own', e.target.value)}/></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'diary' && (
                            <div className="h-[calc(100vh-140px)] flex flex-col">
                                <div className="flex justify-between items-end mb-4 px-2"><div><h2 className="text-2xl font-bold text-gray-800">Daily Diary</h2><p className={`text-${themeColor}-600 font-medium text-sm`}>{currentTime.toLocaleDateString()}</p></div><div className="flex gap-2"><input type="time" className="bg-white border rounded px-2 py-1" value={customDiaryTime} onChange={e=>setCustomDiaryTime(e.target.value)}/><button onClick={handleInsertTime} className={`bg-${themeColor}-100 text-${themeColor}-700 px-3 py-1 rounded-lg text-sm font-bold flex gap-1 items-center`}><Clock size={16}/> Insert</button></div></div>
                                <div className="flex-1 bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative"><textarea className="flex-1 p-6 w-full resize-none outline-none text-gray-700 leading-relaxed text-lg bg-transparent z-10" placeholder="Start typing..." value={diaryEntry} onChange={(e) => setDiaryEntry(e.target.value)}></textarea><div className="absolute inset-0 pointer-events-none opacity-5" style={{backgroundImage: 'linear-gradient(#000 1px, transparent 1px)', backgroundSize: '100% 32px', marginTop: '34px'}}></div></div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4 px-2">Past Records</h2>
                                {historyLogs.map(log => {
                                    const total = Object.values(log.studyData || {}).reduce((a, b) => a + (b.self || 0) + (b.own || 0), 0);
                                    return <button key={log.id} onClick={() => setSelectedLog(log)} className="w-full bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-all flex justify-between items-center text-left"><div><div className={`font-bold text-gray-800 text-lg`}>{new Date(log.date).toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'})}</div><div className="text-xs text-gray-500 mt-2">Routine: {log.grades?.routine?.grade} â€¢ Study: {total}h ({log.grades?.study?.grade})</div></div><div className={`w-10 h-10 rounded-xl flex items-center justify-center font-bold text-white shadow-sm ${getGradeColor(log.grades?.overall?.grade)}`}>{log.grades?.overall?.grade}</div></button>
                                })}
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center mb-2 px-2"><h2 className="text-2xl font-bold text-gray-800">Analytics</h2><div className={`bg-${themeColor}-50 text-${themeColor}-700 px-3 py-1 rounded-full text-xs font-bold border border-${themeColor}-100 flex items-center gap-1`}><Trophy size={14}/> Level {gamificationStats.level}</div></div>
                                <div className={`bg-gradient-to-r from-${themeColor}-500 to-${themeColor}-700 rounded-2xl p-6 text-white shadow-lg`}>
                                    <div className="flex justify-between items-start mb-4"><div><div className="text-xs font-medium opacity-80 uppercase tracking-wider">Gamer Profile</div><div className="text-2xl font-bold flex items-center gap-2">Student Lvl {gamificationStats.level} <Zap className="text-yellow-300 fill-current" size={20}/></div></div></div>
                                    <div className="relative pt-1"><div className="flex mb-2 justify-between text-xs font-semibold text-indigo-100"><span>XP Progress</span><span>{gamificationStats.xp} / {gamificationStats.nextLevelXp} XP</span></div><div className="overflow-hidden h-2 mb-4 text-xs flex rounded bg-black/20"><div style={{ width: `${gamificationStats.progress}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-400 transition-all duration-1000"></div></div></div>
                                </div>
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h3 className="font-bold text-gray-700 mb-6 flex items-center gap-2"><PieChart size={18} className="text-emerald-500"/> Study Distribution</h3><SubjectPieChart history={historyLogs} /></div>
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><Calendar size={18} className="text-blue-500"/> Consistency Map</h3><ConsistencyHeatmap history={historyLogs} /></div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-200 pb-6 pt-2 px-6 flex justify-between z-40">
                        {[
                            { id: 'routine', icon: List, label: 'Routine' },
                            { id: 'study', icon: BookOpen, label: 'Study' },
                            { id: 'diary', icon: Edit3, label: 'Diary' },
                            { id: 'history', icon: HistoryIcon, label: 'History' },
                            { id: 'analytics', icon: BarChart3, label: 'Analytics' },
                        ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 ${activeTab === tab.id ? `text-${themeColor}-600 scale-110` : 'text-gray-400'}`}>
                                <tab.icon size={24} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
                                <span className="text-[10px] font-bold">{tab.label}</span>
                            </button>
                        ))}
                    </nav>

                    {showEndDayModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in zoom-in duration-200">
                            <div className="bg-white rounded-3xl w-full max-w-md max-h-[85vh] overflow-y-auto shadow-2xl flex flex-col">
                                <div className="p-5 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10"><h3 className="font-bold text-lg text-gray-800">Finalize Day</h3><button onClick={() => setShowEndDayModal(false)}><X size={20}/></button></div>
                                <div className="p-5 space-y-6">
                                    <div className="bg-blue-50 p-4 rounded-xl text-blue-900 text-sm"><h4 className="font-bold mb-1">Current Study Status</h4><p>Logged <strong>{getTotalStudy()} hours</strong> today.</p><div className="mt-2 flex items-center gap-2 text-xs font-bold text-blue-700"><Coins size={14}/> Earn {Math.floor(getTotalStudy() * 10)} XP Coins</div></div>
                                    <div><h4 className="font-bold text-gray-700 mb-2">Rate Your Schedule</h4><div className="space-y-2 max-h-60 overflow-y-auto pr-1 no-scrollbar">{schedule.map((item, idx) => (<div key={idx} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><span className="text-xs font-bold text-gray-600 w-1/2 leading-tight">{item.label}</span><StarRating rating={dailyRatings[item.time] || 0} setRating={(r) => setDailyRatings(prev => ({ ...prev, [item.time]: r }))} /></div>))}</div></div>
                                    <button onClick={handleEndDay} disabled={isSubmitting} className={`w-full bg-${themeColor}-600 text-white py-4 rounded-2xl font-bold shadow-xl flex justify-center items-center gap-2 disabled:opacity-70`}>{isSubmitting ? <Loader2 className="animate-spin" size={20} /> : <><BarChart3 size={20} /> {todayGrades ? "Update & Save" : "Finish & Collect XP"}</>}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showShopModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                            <div className="bg-white rounded-3xl w-full max-w-md max-h-[85vh] overflow-y-auto shadow-2xl flex flex-col">
                                <div className="p-5 border-b border-gray-100 flex justify-between items-center"><h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><ShoppingBag className={`text-${themeColor}-600`} /> XP Shop</h3><button onClick={() => setShowShopModal(false)}><X size={20}/></button></div>
                                <div className="p-5 space-y-3">
                                    <div className="flex items-center justify-between bg-yellow-50 p-4 rounded-xl mb-4 border border-yellow-100"><span className="text-yellow-800 font-bold text-sm">Wallet Balance</span><div className="flex items-center gap-1.5 text-xl font-bold text-yellow-600">{userStats.walletBalance || 0} <Coins size={20} fill="currentColor" /></div></div>
                                    {Object.values(THEMES).map(theme => {
                                        const isUnlocked = userStats.unlockedThemes?.includes(theme.id) || theme.id === 'indigo';
                                        const isEquipped = userStats.currentTheme === theme.id || (!userStats.currentTheme && theme.id === 'indigo');
                                        const canAfford = (userStats.walletBalance || 0) >= theme.price;
                                        return (
                                            <div key={theme.id} className={`flex items-center justify-between p-3 rounded-xl border-2 ${isEquipped ? `border-${themeColor}-500 bg-${themeColor}-50` : 'border-gray-100 bg-white'}`}>
                                                <div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full bg-${theme.color}-500 shadow-sm`}></div><div><div className="font-bold text-gray-800">{theme.label}</div><div className="text-xs text-gray-500 font-medium">{theme.price === 0 ? "Free" : `${theme.price} XP Coins`}</div></div></div>
                                                <div>{isEquipped ? <span className={`text-xs font-bold text-${theme.color}-600 flex items-center gap-1 bg-white px-2 py-1 rounded-lg shadow-sm`}><Check size={12}/> Active</span> : isUnlocked ? <button onClick={() => handleEquipTheme(theme.id)} className="text-xs font-bold bg-gray-900 text-white px-3 py-1.5 rounded-lg hover:bg-gray-800">Equip</button> : <button onClick={() => handleBuyTheme(theme)} disabled={!canAfford} className={`text-xs font-bold px-3 py-1.5 rounded-lg flex items-center gap-1 ${canAfford ? 'bg-yellow-400 text-yellow-900 hover:bg-yellow-500' : 'bg-gray-200 text-gray-400'}`}>Buy <Coins size={12}/></button>}</div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedLog && <HistoryModal log={selectedLog} onClose={() => setSelectedLog(null)} themeColor={themeColor} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- Register Service Worker for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered!', reg)).catch(err => console.log('SW failed', err));
            });
        }
    </script>
</body>
</html>

